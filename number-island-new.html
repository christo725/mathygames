<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Island - Math Adventure Game</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFE4B5 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
        }

        /* Floating animations */
        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .floating:nth-child(2) { animation-delay: -1s; }
        .floating:nth-child(3) { animation-delay: -2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* Bounce animation */
        .bounce {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -15px, 0); }
            70% { transform: translate3d(0, -7px, 0); }
            90% { transform: translate3d(0, -3px, 0); }
        }

        /* Particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particle 1s ease-out forwards;
        }

        @keyframes particle {
            0% {
                transform: scale(1) translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(0.2) translateY(-100px) rotate(180deg);
                opacity: 0;
            }
        }

        /* Button styles */
        .btn {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1.4rem;
            font-weight: bold;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }

        .btn-success {
            background: linear-gradient(45deg, #56AB2F, #A8E6CF);
        }

        /* Start Screen */
        .start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }

        .title {
            font-size: 4rem;
            color: #2E8B57;
            text-shadow: 3px 3px 0 #FFD700;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .subtitle {
            font-size: 1.5rem;
            color: #FF4500;
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* Island Map */
        .island-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(180deg, #87CEEB 0%, #40E0D0 50%, #20B2AA 100%);
        }

        .map-title {
            font-size: 2.5rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .stats-bar {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .zones-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 800px;
        }

        .zone {
            background: linear-gradient(135deg, #FFE4B5, #DDA0DD);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .zone:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
        }

        .zone-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            display: block;
        }

        .zone-title {
            font-size: 1.8rem;
            color: #2E8B57;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .zone-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        /* Game Screen */
        .game-screen {
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            height: 12px;
            flex: 1;
            margin: 0 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .question-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-text {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .visual-aid {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .shell, .crystal, .potion-part {
            font-size: 2rem;
            display: inline-block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0); }
            to { opacity: 1; transform: scale(1); }
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .answer-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .answer-btn.correct {
            background: linear-gradient(45deg, #56AB2F, #A8E6CF);
            animation: correctAnswer 0.6s ease;
        }

        .answer-btn.incorrect {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            animation: shake 0.5s ease;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Avatar customization */
        .avatar-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .avatar:hover {
            transform: scale(1.1);
        }

        .pet {
            font-size: 2rem;
            animation: float 2s ease-in-out infinite;
        }

        /* Results screen */
        .results-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .results-title {
            font-size: 3rem;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .results-stats {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.3rem;
            color: #333;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }

            .zones-container {
                grid-template-columns: 1fr;
            }

            .game-header {
                flex-direction: column;
                align-items: stretch;
            }

            .progress-bar {
                margin: 10px 0;
            }

            .question-text {
                font-size: 1.4rem;
            }

            .answers-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .avatar {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .btn {
                font-size: 1.1rem;
                padding: 12px 20px;
            }

            .answers-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .answer-btn {
                padding: 15px;
                font-size: 1.3rem;
            }
        }

        /* Loading animation */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-size: 2rem;
            color: #2E8B57;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E8B57;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-right: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bubble {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.2) translateY(-5px); }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.7; transform: scale(1) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.3) rotate(180deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Sound effects using Web Audio API
        const createAudioContext = () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const playTone = (frequency, duration, type = 'sine') => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            };

            return {
                playSuccess: () => {
                    playTone(523, 0.2); // C5
                    setTimeout(() => playTone(659, 0.2), 100); // E5
                    setTimeout(() => playTone(784, 0.3), 200); // G5
                },
                playError: () => {
                    playTone(200, 0.5, 'sawtooth');
                },
                playCoin: () => {
                    playTone(800, 0.1);
                    setTimeout(() => playTone(1000, 0.1), 50);
                },
                playClick: () => {
                    playTone(600, 0.1, 'square');
                }
            };
        };

        let audio = null;
        try {
            audio = createAudioContext();
        } catch (e) {
            console.log('Audio not supported');
        }

        // Game state management
        const useGameState = () => {
            const [gameData, setGameData] = useState(() => {
                const saved = localStorage.getItem('numberIslandData');
                return saved ? JSON.parse(saved) : {
                    coconuts: 0,
                    totalProblems: 0,
                    totalCorrect: 0,
                    zones: {
                        beach: { stars: 0, completed: 0 },
                        caves: { stars: 0, completed: 0 },
                        rapids: { stars: 0, completed: 0 }
                    },
                    avatar: { color: '#FF6B35', pet: 'üê¢' },
                    currentStreak: 0,
                    bestStreak: 0
                };
            });

            const saveData = useCallback((newData) => {
                setGameData(newData);
                localStorage.setItem('numberIslandData', JSON.stringify(newData));
            }, []);

            return [gameData, saveData];
        };

        // Particle effect component
        const ParticleEffect = ({ x, y, show, type = 'star' }) => {
            if (!show) return null;

            const particles = [];
            const symbols = type === 'star' ? ['‚≠ê', '‚ú®', 'üí´'] : ['ü••', 'üí∞', 'ü™ô'];
            
            for (let i = 0; i < 6; i++) {
                particles.push(
                    <div
                        key={i}
                        className="particle"
                        style={{
                            left: x + Math.random() * 100 - 50,
                            top: y + Math.random() * 100 - 50,
                            fontSize: '1.5rem',
                            animationDelay: `${i * 0.1}s`
                        }}
                    >
                        {symbols[Math.floor(Math.random() * symbols.length)]}
                    </div>
                );
            }

            return <>{particles}</>;
        };

        // Start Screen Component
        const StartScreen = ({ onPlay, gameData }) => (
            <div className="start-screen">
                <div className="floating">üèùÔ∏è</div>
                <h1 className="title">Number Island</h1>
                <p className="subtitle">üåü Math Adventure Awaits! üåü</p>
                
                {gameData.totalProblems > 0 && (
                    <div className="stats-bar">
                        <div className="stat">ü•• {gameData.coconuts}</div>
                        <div className="stat">üìä {gameData.totalProblems} Problems</div>
                        <div className="stat">üî• Best Streak: {gameData.bestStreak}</div>
                    </div>
                )}
                
                <button className="btn" onClick={() => {
                    audio?.playClick();
                    onPlay();
                }}>
                    üè¥‚Äç‚ò†Ô∏è Start Adventure!
                </button>
            </div>
        );

        // Avatar customization
        const AvatarCustomizer = ({ avatar, onUpdate }) => {
            const colors = ['#FF6B35', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
            const pets = ['üê¢', 'ü¶Ä', 'üêô', 'üê†', 'ü¶ú', 'üêí'];

            return (
                <div className="avatar-container">
                    <div 
                        className="avatar bounce"
                        style={{ background: avatar.color }}
                        onClick={() => {
                            const newColor = colors[Math.floor(Math.random() * colors.length)];
                            onUpdate({ ...avatar, color: newColor });
                        }}
                    >
                        üë§
                    </div>
                    <div className="pet" onClick={() => {
                        const newPet = pets[Math.floor(Math.random() * pets.length)];
                        onUpdate({ ...avatar, pet: newPet });
                    }}>
                        {avatar.pet}
                    </div>
                    <div>
                        <h3>Click to customize!</h3>
                        <p>Avatar & Pet</p>
                    </div>
                </div>
            );
        };

        // Island Map Component
        const IslandMap = ({ gameData, onZoneSelect, onCustomizeAvatar }) => (
            <div className="island-map">
                <h2 className="map-title">üèùÔ∏è Number Island</h2>
                
                <AvatarCustomizer 
                    avatar={gameData.avatar} 
                    onUpdate={onCustomizeAvatar}
                />

                <div className="stats-bar">
                    <div className="stat">ü•• {gameData.coconuts}</div>
                    <div className="stat">‚≠ê {Object.values(gameData.zones).reduce((sum, zone) => sum + zone.stars, 0)} Stars</div>
                    <div className="stat">üéØ {Math.round((gameData.totalCorrect / Math.max(gameData.totalProblems, 1)) * 100)}% Accuracy</div>
                </div>

                <div className="zones-container">
                    <div className="zone floating" onClick={() => {
                        audio?.playClick();
                        onZoneSelect('beach');
                    }}>
                        <span className="zone-icon">üèñÔ∏è</span>
                        <h3 className="zone-title">Coconut Beach</h3>
                        <p className="zone-description">Help the crab build sandcastles with addition & subtraction!</p>
                        <div className="stars">
                            {[1, 2, 3].map(i => (
                                <span key={i} style={{ fontSize: '1.5rem', color: i <= gameData.zones.beach.stars ? '#FFD700' : '#DDD' }}>
                                    ‚≠ê
                                </span>
                            ))}
                        </div>
                    </div>

                    <div className="zone floating" onClick={() => {
                        audio?.playClick();
                        onZoneSelect('caves');
                    }}>
                        <span className="zone-icon">üíé</span>
                        <h3 className="zone-title">Crystal Caves</h3>
                        <p className="zone-description">Mine magical crystals with multiplication magic!</p>
                        <div className="stars">
                            {[1, 2, 3].map(i => (
                                <span key={i} style={{ fontSize: '1.5rem', color: i <= gameData.zones.caves.stars ? '#FFD700' : '#DDD' }}>
                                    ‚≠ê
                                </span>
                            ))}
                        </div>
                    </div>

                    <div className="zone floating" onClick={() => {
                        audio?.playClick();
                        onZoneSelect('rapids');
                    }}>
                        <span className="zone-icon">üåà</span>
                        <h3 className="zone-title">Rainbow Rapids</h3>
                        <p className="zone-description">Mix magical potions with fractions!</p>
                        <div className="stars">
                            {[1, 2, 3].map(i => (
                                <span key={i} style={{ fontSize: '1.5rem', color: i <= gameData.zones.rapids.stars ? '#FFD700' : '#DDD' }}>
                                    ‚≠ê
                                </span>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );

        // Problem generators
        const generateBeachProblem = () => {
            const type = Math.random() > 0.5 ? 'add' : 'subtract';
            if (type === 'add') {
                const a = Math.floor(Math.random() * 50) + 10;
                const b = Math.floor(Math.random() * 30) + 5;
                return {
                    question: `The crab needs ${a + b} shells for the castle. It has ${a} shells. How many more does it need?`,
                    answer: b,
                    visual: { type: 'shells', count: a, target: a + b },
                    choices: [b, b + 2, b - 2, b + 5].sort(() => Math.random() - 0.5)
                };
            } else {
                const total = Math.floor(Math.random() * 80) + 20;
                const subtract = Math.floor(Math.random() * (total - 10)) + 5;
                return {
                    question: `The crab had ${total} shells but ${subtract} got washed away. How many are left?`,
                    answer: total - subtract,
                    visual: { type: 'shells', count: total, remove: subtract },
                    choices: [total - subtract, total - subtract + 3, total - subtract - 3, total - subtract + 7].sort(() => Math.random() - 0.5)
                };
            }
        };

        const generateCavesProblem = () => {
            const a = Math.floor(Math.random() * 10) + 2;
            const b = Math.floor(Math.random() * 10) + 2;
            return {
                question: `You found ${a} groups of crystals with ${b} crystals in each group. How many crystals total?`,
                answer: a * b,
                visual: { type: 'crystals', groups: a, perGroup: b },
                choices: [a * b, a * b + a, a * b - a, a + b].sort(() => Math.random() - 0.5)
            };
        };

        const generateRapidsProblem = () => {
            const fractions = [
                { num: 1, den: 2, display: '1/2' },
                { num: 1, den: 4, display: '1/4' },
                { num: 3, den: 4, display: '3/4' },
                { num: 1, den: 3, display: '1/3' },
                { num: 2, den: 3, display: '2/3' }
            ];
            
            const frac = fractions[Math.floor(Math.random() * fractions.length)];
            const total = frac.den * (Math.floor(Math.random() * 3) + 2);
            const needed = (frac.num * total) / frac.den;
            
            return {
                question: `Fill the potion bottle ${frac.display} full. The bottle holds ${total} drops. How many drops do you need?`,
                answer: needed,
                visual: { type: 'potion', total: total, fill: needed, fraction: frac.display },
                choices: [needed, needed + frac.den, needed - 1, total - needed].filter(x => x > 0).sort(() => Math.random() - 0.5)
            };
        };

        // Game Visual Components with actual game mechanics
        const BeachGame = ({ visual, showAnswer, currentProblem, score, selectedAnswer, problem }) => {
            const [castleHeight, setCastleHeight] = useState(0);
            const [crabPosition, setCrabPosition] = useState(20);
            
            useEffect(() => {
                if (showAnswer && selectedAnswer === problem.answer) {
                    // Animate crab building castle
                    setCrabPosition(50);
                    setTimeout(() => setCastleHeight(castleHeight + 1), 500);
                }
            }, [showAnswer]);

            // Build sandcastle visualization
            const castleLayers = [];
            for (let i = 0; i < score; i++) {
                castleLayers.push(
                    <div key={i} style={{
                        width: `${100 - i * 10}px`,
                        height: '30px',
                        backgroundColor: '#DEB887',
                        border: '2px solid #8B7355',
                        borderRadius: '5px',
                        margin: '2px auto',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '1.2rem'
                    }}>
                        üè∞
                    </div>
                );
            }

            const shells = [];
            for (let i = 0; i < (showAnswer ? visual.target : visual.count); i++) {
                shells.push(
                    <span 
                        key={i} 
                        className="shell" 
                        style={{ 
                            animationDelay: `${i * 0.1}s`,
                            transform: showAnswer ? 'translateY(-10px)' : 'none',
                            transition: 'transform 0.5s ease'
                        }}
                    >
                        üêö
                    </span>
                );
            }

            return (
                <div className="visual-aid">
                    <div style={{ 
                        background: 'linear-gradient(180deg, #87CEEB 0%, #F4A460 100%)',
                        borderRadius: '15px',
                        padding: '20px',
                        margin: '10px 0',
                        position: 'relative',
                        minHeight: '200px'
                    }}>
                        {/* Beach Scene */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>
                            {/* Crab Character */}
                            <div style={{ 
                                fontSize: '3rem',
                                transform: `translateX(${crabPosition}px)`,
                                transition: 'transform 1s ease',
                                textShadow: '2px 2px 4px rgba(0,0,0,0.3)'
                            }}>
                                ü¶Ä
                            </div>

                            {/* Sandcastle */}
                            <div style={{ display: 'flex', flexDirection: 'column-reverse', alignItems: 'center' }}>
                                {castleLayers}
                                <div style={{ fontSize: '1.5rem', marginTop: '10px' }}>
                                    {score > 0 ? 'üè∞' : 'üèñÔ∏è'} Castle Progress: {score}/10
                                </div>
                            </div>
                        </div>

                        {/* Shells Collection */}
                        <div style={{ marginTop: '20px' }}>
                            <div style={{ fontSize: '1.2rem', marginBottom: '10px', color: '#2E8B57', fontWeight: 'bold' }}>
                                üêö Shells Collected:
                            </div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                                {shells}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CavesGame = ({ visual, showAnswer, score, selectedAnswer, problem }) => {
            const [minedCrystals, setMinedCrystals] = useState(0);
            const [pickaxeSwing, setPickaxeSwing] = useState(false);

            useEffect(() => {
                if (showAnswer && selectedAnswer === problem.answer) {
                    setPickaxeSwing(true);
                    setTimeout(() => {
                        setPickaxeSwing(false);
                        setMinedCrystals(minedCrystals + visual.groups * visual.perGroup);
                    }, 600);
                }
            }, [showAnswer]);

            const crystalGroups = [];
            for (let g = 0; g < visual.groups; g++) {
                const crystals = [];
                for (let c = 0; c < visual.perGroup; c++) {
                    crystals.push(
                        <span 
                            key={`${g}-${c}`} 
                            className="crystal"
                            style={{
                                fontSize: '1.8rem',
                                filter: showAnswer ? 'brightness(1.5) drop-shadow(0 0 10px #4ECDC4)' : 'none',
                                transition: 'all 0.5s ease'
                            }}
                        >
                            üíé
                        </span>
                    );
                }
                crystalGroups.push(
                    <div key={g} style={{ 
                        margin: '15px', 
                        padding: '15px', 
                        border: '3px dashed #8A2BE2', 
                        borderRadius: '15px',
                        backgroundColor: 'rgba(138, 43, 226, 0.1)',
                        transform: showAnswer ? 'scale(1.05)' : 'scale(1)',
                        transition: 'transform 0.5s ease'
                    }}>
                        <div style={{ fontSize: '1rem', color: '#8A2BE2', fontWeight: 'bold', marginBottom: '5px' }}>
                            Group {g + 1}
                        </div>
                        {crystals}
                    </div>
                );
            }

            return (
                <div className="visual-aid">
                    <div style={{
                        background: 'linear-gradient(135deg, #2C1810 0%, #8A2BE2 50%, #4B0082 100%)',
                        borderRadius: '15px',
                        padding: '20px',
                        margin: '10px 0',
                        color: 'white',
                        position: 'relative'
                    }}>
                        {/* Cave Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <div style={{ fontSize: '2rem' }}>
                                <span style={{ 
                                    transform: pickaxeSwing ? 'rotate(45deg)' : 'rotate(0deg)',
                                    transition: 'transform 0.3s ease',
                                    display: 'inline-block'
                                }}>
                                    ‚õèÔ∏è
                                </span>
                                <span style={{ marginLeft: '10px', fontSize: '1.2rem' }}>
                                    Mining Crystals...
                                </span>
                            </div>
                            <div style={{ fontSize: '1.2rem' }}>
                                üíé Total Mined: {score * 10}
                            </div>
                        </div>

                        {/* Crystal Groups */}
                        <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center' }}>
                            {crystalGroups}
                        </div>

                        {/* Cave floor with scattered gems */}
                        <div style={{ marginTop: '20px', textAlign: 'center' }}>
                            <div style={{ fontSize: '0.8rem', opacity: 0.7 }}>Cave Floor</div>
                            <div>
                                {Array(score).fill().map((_, i) => (
                                    <span key={i} style={{ fontSize: '1.5rem', margin: '0 3px' }}>üíé</span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const RapidsGame = ({ visual, showAnswer, score, selectedAnswer, problem }) => {
            const [potionLevel, setPotionLevel] = useState(0);
            const [bubbling, setBubbling] = useState(false);

            useEffect(() => {
                if (showAnswer && selectedAnswer === problem.answer) {
                    setBubbling(true);
                    setTimeout(() => {
                        setPotionLevel(visual.fill);
                        setBubbling(false);
                    }, 800);
                }
            }, [showAnswer]);

            // Create potion bottle visualization
            const bottleParts = [];
            for (let i = 0; i < visual.total; i++) {
                const isFilled = i < (showAnswer ? visual.fill : 0);
                bottleParts.push(
                    <div 
                        key={i}
                        style={{ 
                            width: '25px', 
                            height: '25px', 
                            backgroundColor: isFilled ? '#FF69B4' : 'rgba(255,255,255,0.3)',
                            border: '2px solid #8A2BE2',
                            display: 'inline-block',
                            margin: '1px',
                            borderRadius: '3px',
                            transition: 'all 0.5s ease',
                            boxShadow: isFilled ? '0 0 10px #FF69B4' : 'none',
                            animation: bubbling && isFilled ? 'bubble 0.5s ease' : 'none'
                        }}
                    />
                );
            }

            return (
                <div className="visual-aid">
                    <div style={{
                        background: 'linear-gradient(135deg, #FF1493 0%, #8A2BE2 50%, #4B0082 100%)',
                        borderRadius: '15px',
                        padding: '20px',
                        margin: '10px 0',
                        color: 'white',
                        textAlign: 'center'
                    }}>
                        {/* Potion Master */}
                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '3rem', marginBottom: '10px' }}>üßô‚Äç‚ôÄÔ∏è</div>
                            <div style={{ fontSize: '1.3rem', fontWeight: 'bold' }}>
                                Potion Master's Lab
                            </div>
                            <div style={{ fontSize: '1rem', opacity: 0.9 }}>
                                Potions Brewed: {score}/10
                            </div>
                        </div>

                        {/* Magic Potion Bottle */}
                        <div style={{ 
                            display: 'inline-block',
                            background: 'linear-gradient(180deg, transparent 0%, rgba(255,255,255,0.1) 100%)',
                            borderRadius: '20px 20px 5px 5px',
                            padding: '20px 15px',
                            border: '3px solid #8A2BE2',
                            position: 'relative'
                        }}>
                            <div style={{ fontSize: '1.2rem', marginBottom: '10px', color: '#FFD700' }}>
                                üß™ Magic Bottle ({visual.fraction})
                            </div>
                            
                            <div style={{ 
                                display: 'grid',
                                gridTemplateColumns: `repeat(${Math.ceil(Math.sqrt(visual.total))}, 1fr)`,
                                gap: '2px',
                                padding: '10px',
                                backgroundColor: 'rgba(0,0,0,0.2)',
                                borderRadius: '10px'
                            }}>
                                {bottleParts}
                            </div>
                            
                            {/* Sparkle effects */}
                            {showAnswer && (
                                <div style={{ position: 'absolute', top: '-10px', left: '50%', transform: 'translateX(-50%)' }}>
                                    <span style={{ fontSize: '2rem', animation: 'sparkle 1s ease infinite' }}>‚ú®</span>
                                </div>
                            )}
                        </div>

                        {/* Ingredient shelf */}
                        <div style={{ marginTop: '20px', fontSize: '1.5rem' }}>
                            <div style={{ fontSize: '1rem', marginBottom: '10px', opacity: 0.8 }}>
                                Magic Ingredients:
                            </div>
                            <div>üåü ‚ö° üîÆ üí´ ü™Ñ</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Game Screen Component
        const GameScreen = ({ zone, gameData, onComplete, onBack }) => {
            const [currentProblem, setCurrentProblem] = useState(0);
            const [problems, setProblems] = useState([]);
            const [score, setScore] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [particles, setParticles] = useState({ show: false, x: 0, y: 0 });
            const [streak, setStreak] = useState(0);

            useEffect(() => {
                // Generate 10 problems for the zone
                const newProblems = [];
                for (let i = 0; i < 10; i++) {
                    if (zone === 'beach') newProblems.push(generateBeachProblem());
                    else if (zone === 'caves') newProblems.push(generateCavesProblem());
                    else if (zone === 'rapids') newProblems.push(generateRapidsProblem());
                }
                setProblems(newProblems);
            }, [zone]);

            const handleAnswer = (answer, event) => {
                if (showAnswer) return;
                
                const isCorrect = answer === problems[currentProblem].answer;
                setSelectedAnswer(answer);
                setShowAnswer(true);

                if (isCorrect) {
                    setScore(score + 1);
                    setStreak(streak + 1);
                    audio?.playSuccess();
                    
                    // Particle effect
                    const rect = event.target.getBoundingClientRect();
                    setParticles({
                        show: true,
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2
                    });
                    
                    setTimeout(() => setParticles({ show: false, x: 0, y: 0 }), 1000);
                } else {
                    setStreak(0);
                    audio?.playError();
                }

                setTimeout(() => {
                    if (currentProblem < problems.length - 1) {
                        setCurrentProblem(currentProblem + 1);
                        setShowAnswer(false);
                        setSelectedAnswer(null);
                    } else {
                        // Game complete
                        const accuracy = (score + (isCorrect ? 1 : 0)) / problems.length;
                        const stars = accuracy >= 0.9 ? 3 : accuracy >= 0.7 ? 2 : 1;
                        const coconutsEarned = (score + (isCorrect ? 1 : 0)) * 10;
                        
                        onComplete({
                            score: score + (isCorrect ? 1 : 0),
                            stars,
                            coconutsEarned,
                            accuracy: Math.round(accuracy * 100)
                        });
                    }
                }, 2000);
            };

            if (!problems.length) return <div className="loading"><div className="spinner"></div>Loading adventure...</div>;

            const problem = problems[currentProblem];
            const zoneInfo = {
                beach: { title: 'üèñÔ∏è Coconut Beach', bg: 'linear-gradient(135deg, #74b9ff, #0984e3)' },
                caves: { title: 'üíé Crystal Caves', bg: 'linear-gradient(135deg, #a29bfe, #6c5ce7)' },
                rapids: { title: 'üåà Rainbow Rapids', bg: 'linear-gradient(135deg, #fd79a8, #e84393)' }
            };

            return (
                <div className="game-screen" style={{ background: zoneInfo[zone].bg }}>
                    <ParticleEffect {...particles} />
                    
                    <div className="game-header">
                        <button className="btn btn-secondary" onClick={onBack}>üîô Back</button>
                        <div className="progress-bar">
                            <div 
                                className="progress-fill" 
                                style={{ width: `${((currentProblem + 1) / problems.length) * 100}%` }}
                            />
                        </div>
                        <div className="stat">ü•• +{score * 10}</div>
                        <div className="stat">üî• {streak}</div>
                    </div>

                    <h2 style={{ textAlign: 'center', color: 'white', marginBottom: '20px' }}>
                        {zoneInfo[zone].title} - Question {currentProblem + 1}/10
                    </h2>

                    {/* Game Scene - This is where the magic happens! */}
                    <div className="question-container">
                        {/* Story/Question Context */}
                        <div className="question-text" style={{ 
                            background: 'rgba(255,255,255,0.95)', 
                            borderRadius: '15px', 
                            padding: '15px', 
                            marginBottom: '20px',
                            border: '3px solid #FFD700'
                        }}>
                            {problem.question}
                        </div>
                        
                        {/* Interactive Game Visual */}
                        {zone === 'beach' && (
                            <BeachGame 
                                visual={problem.visual} 
                                showAnswer={showAnswer} 
                                currentProblem={currentProblem}
                                score={score}
                                selectedAnswer={selectedAnswer}
                                problem={problem}
                            />
                        )}
                        {zone === 'caves' && (
                            <CavesGame 
                                visual={problem.visual} 
                                showAnswer={showAnswer} 
                                score={score}
                                selectedAnswer={selectedAnswer}
                                problem={problem}
                            />
                        )}
                        {zone === 'rapids' && (
                            <RapidsGame 
                                visual={problem.visual} 
                                showAnswer={showAnswer} 
                                score={score}
                                selectedAnswer={selectedAnswer}
                                problem={problem}
                            />
                        )}

                        {/* Answer Selection */}
                        <div style={{ 
                            background: 'rgba(255,255,255,0.9)', 
                            borderRadius: '15px', 
                            padding: '20px', 
                            marginTop: '20px' 
                        }}>
                            <div style={{ fontSize: '1.3rem', marginBottom: '15px', textAlign: 'center', color: '#333' }}>
                                {zone === 'beach' ? 'ü¶Ä Help the crab! Choose your answer:' : 
                                 zone === 'caves' ? '‚õèÔ∏è How many crystals total?' : 
                                 'üßô‚Äç‚ôÄÔ∏è How many drops needed?'}
                            </div>
                            
                            <div className="answers-grid">
                                {problem.choices.map(choice => (
                                    <button
                                        key={choice}
                                        className={`answer-btn ${showAnswer ? 
                                            (choice === problem.answer ? 'correct' : 
                                             choice === selectedAnswer ? 'incorrect' : '') : ''}`}
                                        onClick={(e) => handleAnswer(choice, e)}
                                        disabled={showAnswer}
                                        style={{ 
                                            fontSize: '1.8rem',
                                            padding: '15px',
                                            minWidth: '80px'
                                        }}
                                    >
                                        {choice}
                                    </button>
                                ))}
                            </div>

                            {showAnswer && (
                                <div style={{ 
                                    marginTop: '20px', 
                                    fontSize: '1.4rem', 
                                    textAlign: 'center',
                                    padding: '15px',
                                    borderRadius: '10px',
                                    background: selectedAnswer === problem.answer ? 
                                        'linear-gradient(45deg, #56AB2F, #A8E6CF)' : 
                                        'linear-gradient(45deg, #FF6B6B, #FF8E53)',
                                    color: 'white',
                                    fontWeight: 'bold'
                                }}>
                                    {selectedAnswer === problem.answer ? (
                                        <>
                                            {zone === 'beach' ? 'ü¶Ä The crab is so happy! Well done!' : 
                                             zone === 'caves' ? '‚õèÔ∏è Great mining work! Crystals collected!' : 
                                             'üßô‚Äç‚ôÄÔ∏è Perfect potion! Magic sparkles everywhere!'} 
                                            <div style={{ fontSize: '2rem', marginTop: '10px' }}>
                                                üéâ +10 Coconuts! ü••
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div>The correct answer is {problem.answer}</div>
                                            <div style={{ fontSize: '1rem', marginTop: '5px', opacity: 0.9 }}>
                                                {zone === 'beach' ? "The crab says: 'That's okay, let's try the next castle!'" : 
                                                 zone === 'caves' ? "The miner says: 'No worries, more crystals ahead!'" : 
                                                 "The wizard says: 'Every mistake teaches us something!'"}
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Results Screen Component
        const ResultsScreen = ({ results, onContinue }) => (
            <div className="results-screen">
                <h2 className="results-title">
                    {results.stars === 3 ? 'üåü Amazing!' : results.stars === 2 ? '‚≠ê Great Job!' : 'üëç Good Try!'}
                </h2>
                
                <div className="results-stats">
                    <div className="result-item">
                        <span>Score:</span>
                        <span>{results.score}/10</span>
                    </div>
                    <div className="result-item">
                        <span>Accuracy:</span>
                        <span>{results.accuracy}%</span>
                    </div>
                    <div className="result-item">
                        <span>Stars Earned:</span>
                        <span>{'‚≠ê'.repeat(results.stars)}</span>
                    </div>
                    <div className="result-item">
                        <span>Coconuts Earned:</span>
                        <span>ü•• {results.coconutsEarned}</span>
                    </div>
                </div>

                <button className="btn btn-success" onClick={onContinue}>
                    üèùÔ∏è Back to Island
                </button>
            </div>
        );

        // Main App Component
        const App = () => {
            const [screen, setScreen] = useState('start');
            const [currentZone, setCurrentZone] = useState(null);
            const [results, setResults] = useState(null);
            const [gameData, saveGameData] = useGameState();

            const handleZoneComplete = (gameResults) => {
                const newGameData = {
                    ...gameData,
                    coconuts: gameData.coconuts + gameResults.coconutsEarned,
                    totalProblems: gameData.totalProblems + 10,
                    totalCorrect: gameData.totalCorrect + gameResults.score,
                    zones: {
                        ...gameData.zones,
                        [currentZone]: {
                            ...gameData.zones[currentZone],
                            stars: Math.max(gameData.zones[currentZone].stars, gameResults.stars),
                            completed: gameData.zones[currentZone].completed + 1
                        }
                    },
                    currentStreak: 0,
                    bestStreak: Math.max(gameData.bestStreak, gameResults.score)
                };
                
                saveGameData(newGameData);
                setResults(gameResults);
                setScreen('results');
            };

            const handleAvatarUpdate = (newAvatar) => {
                saveGameData({ ...gameData, avatar: newAvatar });
            };

            return (
                <div className="game-container">
                    {screen === 'start' && (
                        <StartScreen 
                            gameData={gameData}
                            onPlay={() => setScreen('map')}
                        />
                    )}
                    
                    {screen === 'map' && (
                        <IslandMap 
                            gameData={gameData}
                            onZoneSelect={(zone) => {
                                setCurrentZone(zone);
                                setScreen('game');
                            }}
                            onCustomizeAvatar={handleAvatarUpdate}
                        />
                    )}
                    
                    {screen === 'game' && (
                        <GameScreen 
                            zone={currentZone}
                            gameData={gameData}
                            onComplete={handleZoneComplete}
                            onBack={() => setScreen('map')}
                        />
                    )}
                    
                    {screen === 'results' && (
                        <ResultsScreen 
                            results={results}
                            onContinue={() => setScreen('map')}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>